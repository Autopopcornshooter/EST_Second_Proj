<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>배달의 민족</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #e0f7fa; margin: 0; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    header img { height: 50px; }
    header .logout-btn { padding: 6px 12px; background-color: #00bfa5; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .main-section { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
    .main-section .text { margin-bottom: 20px; text-align: center; }
    #address-input { padding: 8px; width: 250px; border-radius: 4px; border: 1px solid #ccc; margin-right: 8px; }
    #Myposition-btn, #verify-btn { padding: 8px 16px; background-color: #00bfa5; color: white; border: none; border-radius: 4px; cursor: pointer; }
    #map { height: 50vh; width: 500px; margin-top: 10px; border-radius: 8px; border: 1px solid #ccc; }
    label { display: block; margin-top: 8px; }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <img src="/images/BaeMin_Logo.jpeg" alt="배달의민족 로고" width="100">
  </div>
  <button class="logout-btn" onclick="logout()" id="logout-btn">로그아웃</button>
</header>

<section class="main-section">
  <div class="text">
    <h3>어디에 살고 계신가요?</h3>
    <input id="address-input" type="text" placeholder="예) 서울 강서구 화곡동">
    <button id="Myposition-btn" name="Myposition-location">내 동네 설정</button>
  </div>
  <div class="text">
    <h3>현재 위치로 동네 인증하기</h3>
    <div id="map"></div>
    <label id="location-firstlabel">현재 위치는 서울 강서구 화곡동입니다.</label>
    <br>
    <button id="verify-btn" name="verify-location">동네인증 완료하기</button>
  </div>
</section>

<form id="location-form" th:action="@{/api/regions}" method="post">
  <input type="hidden" name="address" id="form-address">
  <input type="hidden" name="latitude" id="form-latitude">
  <input type="hidden" name="longitude" id="form-longitude">
  <input type="hidden" name="google_place_id" id="form-google_place_id">
</form>

<script>
  let map;
  let marker;
  let geocoder;

  function initMap() {
    const seoul = { lat: 37.5665, lng: 126.9780 };
    map = new google.maps.Map(document.getElementById("map"), { center: seoul, zoom: 14 });
    marker = new google.maps.Marker({ position: seoul, map: map });
    geocoder = new google.maps.Geocoder();
  }

  document.getElementById("Myposition-btn").addEventListener("click", () => {
    const address = document.getElementById("address-input").value;
    if (!address) { alert("주소를 입력해주세요!"); return; }

    geocoder.geocode({ address }, (results, status) => {
      if (status === "OK") {
        const location = results[0].geometry.location;
        map.setCenter(location);
        marker.setPosition(location);
        document.getElementById("location-firstlabel").innerText =
            "현재 위치는 " + results[0].formatted_address + "입니다.";
      } else {
        alert("주소를 찾을 수 없습니다: " + status);
      }
    });
  });

  document.getElementById("verify-btn").addEventListener("click", () => {
    if (!navigator.geolocation) {
      alert("이 브라우저는 위치 정보를 지원하지 않습니다.");
      return;
    }

    navigator.geolocation.getCurrentPosition((position) => {
      const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };

      geocoder.geocode({ location: userLocation }, (results, status) => {
        let addressText = "";
        let placeId = "";
        if (status === "OK" && results[0]) {
          addressText = results[0].formatted_address;
          placeId = results[0].place_id;
          document.getElementById("location-firstlabel").innerText =
              "현재 위치는 " + addressText + "입니다.";
        }

        // form에 값 넣기
        document.getElementById("form-address").value = addressText;
        document.getElementById("form-latitude").value = userLocation.lat;
        document.getElementById("form-longitude").value = userLocation.lng;
        document.getElementById("form-google_place_id").value = placeId;

        // form 제출
        document.getElementById("location-form").submit();
      });
    });
  });
function logout(){
    fetch('/logout',{method:'POST'})
        .then(()=>window.location.href="/login");    //로그아웃 이후 리다이렉트
}

</script>

<!-- 구글 지도 API -->
<script async defer
        th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${apiKey} + '&callback=initMap'}">
</script>
<script>
    window.addEventListener("load", () => {
        console.log("리소스 로드 완료");
    });
</script>
</body>
</html>
